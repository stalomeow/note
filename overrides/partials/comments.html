{% if page.meta.comments != false %}
  <h2 id="__comments">{{ lang.t("meta.comments") }}</h2>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    !function () {
      const observedElement = document.documentElement;

      function getTheme() {
        const scheme = observedElement.style.getPropertyValue('color-scheme');
        return (scheme === 'dark') ? 'noborder_dark' : 'light';
      }

      function updateTheme() {
        const frame = document.querySelector('.giscus-frame');
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme: getTheme() } } },
          'https://giscus.app'
        );
      }

      function createElement(tag, attributes) {
        const e = document.createElement(tag);
        Object.entries(attributes).forEach(([key, value]) => {
          e.setAttribute(key, value);
        });
        return e;
      }

      // Set palette on initial load
      const comments = document.querySelector('#__comments');
      comments.insertAdjacentElement('afterend', createElement('script', {
        // Insert generated snippet here
        'src': 'https://giscus.app/client.js',
        'data-repo': 'stalomeow/note',
        'data-repo-id': 'R_kgDOIiy-JQ',
        'data-category': 'Announcements',
        'data-category-id': 'DIC_kwDOIiy-Jc4CS79e',
        'data-mapping': 'pathname',
        'data-strict': '0',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'top',
        'data-theme': getTheme(),
        'data-lang': 'zh-CN',
        'data-loading': 'lazy',
        'crossorigin': 'anonymous',
        'async': ''
      }));

      // Instruct Giscus to change theme
      new MutationObserver(() => updateTheme()).observe(observedElement, {
        attributes: true,
        attributeFilter: ['style'],
        attributeOldValue: false,

        characterData: false,
        childList: false,
        subtree: false
      });
    }();
  </script>
{% endif %}