{% if page.meta.comments != false %}
  <h2 id="__comments">{{ lang.t("meta.comments") }}</h2>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    !function () {
      const observedElement = document.documentElement;
      const comments = document.querySelector('#__comments');

      function getTheme() {
        const scheme = observedElement.style.getPropertyValue('color-scheme');
        return (scheme === 'dark') ? 'transparent_dark' : 'light';
      }

      function updateTheme() {
        const frame = document.querySelector('.giscus-frame');
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme: getTheme() } } },
          'https://giscus.app'
        );
      }

      function createElement(tag, attributes) {
        const e = document.createElement(tag);
        Object.entries(attributes).forEach(([key, value]) => {
          e.setAttribute(key, value);
        });
        return e;
      }

      if (__md_scope.hostname === '127.0.0.1') {
        console.warn('本地模式下不加载评论');
        comments.insertAdjacentHTML('afterend', '<p align="center" style="color:red;">本地模式下不加载评论</p>');
      } else {
        // Set palette on initial load
        comments.insertAdjacentElement('afterend', createElement('script', {
          // Insert generated snippet here
          'src': 'https://giscus.app/client.js',
          'data-repo': 'stalomeow/note',
          'data-repo-id': 'R_kgDOIiy-JQ',
          'data-category': 'General',
          'data-category-id': 'DIC_kwDOIiy-Jc4CS79e',
          'data-mapping': 'pathname',
          'data-strict': '0',
          'data-reactions-enabled': '1',
          'data-emit-metadata': '0',
          'data-input-position': 'top',
          'data-theme': getTheme(),
          'data-lang': 'zh-CN',
          'data-loading': 'lazy',
          'crossorigin': 'anonymous',
          'async': ''
        }));

        // Instruct Giscus to change theme
        new MutationObserver(() => updateTheme()).observe(observedElement, {
          attributes: true,
          attributeFilter: ['style'],
          attributeOldValue: false,

          characterData: false,
          childList: false,
          subtree: false
        });
      }
    }();
  </script>
{% endif %}