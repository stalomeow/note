---
date: 2024-12-29T23:17:16
---

# 光线追踪

## Whitted-Style Ray Tracing

### 问题 1：The Utah teapot

Always perform specular reflections/refractions. Where should the ray be reflected for glossy materials?

![[Pasted image 20241230225713.png|The Utah teapot]]

Whitted-Style Ray Tracing 只进行镜面反射，所以只能得到左边的结果。现实中的茶壶不是完全镜面，应该是右边这样。

### 问题 2：The Cornell box

Stop bouncing at diffuse surfaces. No reflections between diffuse materials?

![[Pasted image 20241230230218.png|The Cornell box]]

Whitted-Style Ray Tracing 在漫反射表面停止反射，只能得到左边的结果。现实中应该是右边这样。

## 加速结构

### 均匀网格

### 空间划分

### 物体划分

## Monte Carlo Path Tracing

Path Tracing 基于 [[渲染方程]]，使用 [[Monte Carlo 积分]] 近似求解。

### Direct Illumination Only

Suppose we want to render *one pixel (point)* in the following scene for *direct illumination only*.

![[Pasted image 20241230231018.png|Scene]]

忽略该点的自发光的话，只要用 Monte Carlo 方法求解一个反射方程即可。

$$
\begin{align}
L_o(p,\omega_o)&=\int_{H^2} L_i(p,\omega_i) f_r(p,\omega_i \rightarrow \omega_o) (n \cdot \omega_i) \mathrm{d} \omega_i\\
\\
&\approx \frac{1}{N} \sum_{k=1}^N \frac{L_i(p,\omega_{i_k}) f_r(p,\omega_{i_k} \rightarrow \omega_o) (n \cdot \omega_{i_k})}{pdf(\omega_{i_k})}
\end{align}
$$

其中随机变量 $\omega_{i_k} \sim pdf(\omega_i)$，伪代码

``` diff
shade(p, wo)
    Randomly choose N directions wi~pdf
    Lo = 0.0
    For each wi
        Trace a ray r(p, wi)
        If ray r hit the light
            Lo += (1 / N) * L_i * f_r * cosine / pdf(wi)
    Return Lo
```

### Global Illumination

![[Pasted image 20241230232522.png|What if a ray hits an object?]]

进一步，如果我们在 $P$ 点追踪的光线击中物体 $Q$，只要把 $Q$ 当作光源即可。$Q$ 的等效 `L_i` 就是 `shade(q, -wi)`。

``` diff
shade(p, wo)
    Randomly choose N directions wi~pdf
    Lo = 0.0
    For each wi
        Trace a ray r(p, wi)
        If ray r hit the light
            Lo += (1 / N) * L_i * f_r * cosine / pdf(wi)
+       Else If ray r hit an object at q
+           Lo += (1 / N) * shade(q, -wi) * f_r * cosine / pdf(wi)
    Return Lo
```

#### 问题 1

这个递归函数在开始的时候会进行 $N$ 次随机采样。随着递归深度增加，发出的光线数量是 $N$ 的指数级别，计算量直接爆炸。

![[Pasted image 20241230233347.png|Explosion of rays as bounces go up]]

除非 $N=1$。
