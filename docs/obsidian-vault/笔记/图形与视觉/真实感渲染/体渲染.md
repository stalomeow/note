---
date: 2024-12-31T17:29:34
---

# 体渲染

体渲染的建模如下

![[Pasted image 20241231230050.png|Volume Rendering]]

光会与其中的粒子产生作用，大致分为几种

- 吸收（Absorption）：入射光被粒子吸收，出射光强度变弱
- 外散射（Out-scattering）：入射光被粒子弹射到圆柱外面，圆柱区域的出射光强度变弱
- 内散射（In-scattering）：其他地方的光被粒子弹射过来，圆柱区域的出射光强度变强
- 放射（Emission）：粒子本身发光，使得圆柱区域的出射光强度变强

![[Pasted image 20241231225035.png|光与粒子]]

总结成公式

$$
L_o-L_i=-L_\text{absorption}-L_\text{out-scattering}+L_\text{in-scattering}+L_\text{emission}
$$

## Beer–Lambert law

假设圆柱体的底面积为 $E$，粒子密度为 $\rho$。当圆柱体的厚度 $\mathrm{d}s$ 足够小时，可以认为圆柱体只有一层薄薄的粒子，粒子之间不会重叠。如果粒子都是半径为 $r$ 的球，它们占的总面积为 $\rho \pi r^2 E\mathrm{d}s$。

只考虑 Absorption 的话，光被吸收的概率为 $\dfrac{\rho \pi r^2 E\mathrm{d}s}{E}=\rho \pi r^2 \mathrm{d}s$，所以

$$
\mathrm{d}L=- \rho(s) \pi r^2 L(s)\mathrm{d}s=-\tau(s)L(s)\mathrm{d}s
$$

解得

$$
L(s)=L_0 e^{-\displaystyle\int_0^s \tau(t) \mathrm{d}t}
$$

光的强度呈指数衰减，这被称为 Beer–Lambert law。

![[Pasted image 20250101001411.png|Beer-Lambert law]]

## Transmittance

定义透射比（transmittance）

$$
T(s)=\frac{L(s)}{L_0}=e^{-\displaystyle\int_0^s \tau(t) \mathrm{d}t}
$$

表示粒子群的透明程度。

## Optical Depth

$\tau$ 称为光学厚度（optical depth），分布可以不均匀。

![[Pasted image 20250101002358.png|optical depth]]

## Volume Rendering Equation

参考前面的 Absorption，可以列出完整方程（对应一开始建模时的公式）

$$
\mathrm{d}L=-\tau_a(s)L(s)\mathrm{d}s-\tau_s(s)L(s)\mathrm{d}s+\tau_s(s)L_s(s)\mathrm{d}s+\tau_a(s)L_e(s)\mathrm{d}s
$$

- 因为散射比其他物理过程更复杂，所以使用 $\tau_a(s)$ 和 $\tau_s(s)$ 两个光学厚度
- $L_s(s)$ 是其他地方过来的 In-scattering 光，$L_e(s)$ 是粒子的 Emission 光

为了方便计算，令 $\tau_t=\tau_a+\tau_s$，则

$$
\mathrm{d}L=-\tau_t(s)L(s)\mathrm{d}s+\tau_s(s)L_s(s)\mathrm{d}s+\tau_a(s)L_e(s)\mathrm{d}s
$$

这是一个 [[线性微分方程|变系数非齐次线性微分方程]]，解得

$$
L(s)=\int_0^s e^{-\displaystyle\int_v^s\tau_t(u)\mathrm{d}u} \bigg (\tau_s(v)L_s(v)+\tau_a(v)L_e(v) \bigg) \mathrm{d}v + L_0 e^{-\displaystyle\int_0^s \tau_t(u)\mathrm{d}u}
$$

## 参考

- [NeRF入门之体渲染 (Volume Rendering) - 知乎](https://zhuanlan.zhihu.com/p/595117334)

知乎文章讲得很通俗，但最后方程算错了。另外，假设 $\tau_t=\tau_a=\tau_s$ 也不合理，因为 $\tau_t=\tau_a+\tau_s$，这样假设就全是 $0$ 了。
